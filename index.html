<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>신경과 랜덤 Post-test 퀴즈</title>
  <link rel="manifest" href="manifest.json?v=5">
  <meta name="theme-color" content="#4CAF50">
  <style>
    body { font-family: Arial, sans-serif; max-width:800px; margin:20px auto; padding:16px; text-align:center; }
    header { display:flex; justify-content:space-between; align-items:center; gap:12px; }
    h1 { margin:0; font-size:1.25rem; }
    #status { color:#666; font-size:0.95rem; margin-top:8px; text-align:left; }
    .question { margin:20px 0; font-size:1.15rem; white-space:pre-line; text-align:left; }
    .answer { margin-top:10px; font-weight:600; color:#0a6; white-space:pre-line; display:none; text-align:left; }
    .controls { margin-top:18px; }
    button { padding:10px 14px; margin:6px; font-size:1rem; }
    .progress-wrap { margin-top:14px; text-align:left; }
    .progress-info { font-size:0.92rem; color:#444; margin-bottom:6px; }
    .progress-bar { width:100%; height:12px; background:#eee; border-radius:8px; overflow:hidden; }
    .progress-inner { height:100%; width:0%; background:#4caf50; transition: width 0.25s ease; }
    small.note { display:block; color:#888; margin-top:8px; text-align:left; }
  </style>
</head>
<body>
  <header>
    <h1>신경과 랜덤 Post-test 퀴즈</h1>
    <div>
      <button id="btnToggleMode">복습 모드로</button>
      <button id="btnReset">초기화</button>
    </div>
  </header>

  <div id="status" aria-live="polite">로딩 중...</div>

  <div class="question" id="question">문제가 여기에 표시됩니다.</div>
  <div class="answer" id="answer"></div>

  <div class="controls" id="controls">
    <button id="btnShowAnswer">정답 보기</button>
    <button id="btnMarkWrong">오답 저장</button>
    <button id="btnPrev">이전 문제</button>
    <button id="btnNext">다음 문제</button>
    <!-- 복습 모드에서 첫 문제로 돌아가기 버튼 -->
    <button id="btnRestartReview" style="display:none;">복습 첫 문제로</button>
    <!-- 복습 모드에서 오답 제거 버튼 -->
    <button id="btnRemoveWrong" style="display:none;">오답 제거</button>
  </div>

  <div class="progress-wrap">
    <div class="progress-info" id="progressInfo">진행: 0 / 0 (남음: 0)</div>
    <div class="progress-bar"><div id="progressInner" class="progress-inner"></div></div>
    <small class="note">※ 정답 보기 버튼은 정답만 보여줍니다. 다음 문제로 이동하려면 '다음 문제' 버튼을 누르세요.</small>
  </div>

<script>
  // 기존 문제 데이터
  const questions = [
    { q: "62세 오른손잡이 남자 환자가 Rt. side weakness를 주소 응급실에 내원하였다. 가지고 있는 과거력으로는 HTN, DM, Hyperlipidemia가 있었으며, 50갑년의 흡연력을 가지고 있다. <br>내원 후 시행한 EKG에서 A. fib이 확인되었다. 환자는 증상 발생 후 1시간 이내 본원 응급실로 내원하였다.<br>내원 당시 시행한 신경학적 진찰 상 mental status는 alert 하였으며 moderate dysarthric speech를 보이고 있었다. Language function test 했을 때 묻는 말을 이해할 수 있었으며 의미있는 문장을 구사할 수 없었고, 따라 하기와 이름대기는 불가능하였다. <br>Cranial nerve function test 했을 때 환자의 pupil size 및 light reflex는 정상이었으나 양안 모두 왼쪽으로 치우쳐지려는 경향 보였고, 오른쪽 입고리가 쳐져 있는 모습 보였다. <br>환자의 고개 또한 왼쪽으로 틀어져 있었다. 또한 Nex. 했을 때 Gerstmann syndrome이 보였다.<br>사지 근력을 측정했을 때, 오른쪽 상하지 모두 중력에 대해서는 겨우 들 수 있었다. 통증을 주었을 때 오른쪽 상하지 감각 저하 소견 보였다. 오른쪽 Babinski sign 양성으로 확인 되었다. <br>환자분은 NIHSS 12점으로 측정되었으며, 최근 3주 이내 수술한 기왕력 및 기타 출혈 경향성 등은 모두 정상적이었고, 응급실 내원 후 시행한 lab에서도 큰 이상 보이지 않았다. <br>혈압과 혈당 등 vital sign 모두 정상이었고, initial brain CT 상 hemorrhage 및 hypodense lesion이 없는 것을 확인하였으며, next step으로 촬영한 CT angio perfusion 영상에서 penumbra가 확인 되었다.<br>다음 물음에 답하시오.<br>1. 위 환자의 신경학적 진찰 상 보이는 aphasia의 유형을 쓰시오.<br>2. 위 환자 신경학적 진찰 상 오른쪽 상하지 motor grade 쓰시오.<br>3. 위 환자의 예상되는 진단명을 아는 대로 쓰고, Willis circle에서 문제가 있을 수 있는 혈관들을 아는대로 쓰시고, 내원 후 진행할 수 있는 치료 flow를 아는대로 쓰시오. 이때 제일 중요한 치료법 하나는 꼭 포함할 것.", a: "1. Broca’s aphasia<br><img src='1.png' style='max-width:600px;'><br>2. Grade 3<br><img src='2.png' style='max-width:600px;'><br>3. 진단명: Lt. MCA infarction, Lt. ICA infarction<br>문제되는 혈관: Lt. MCA, Lt, ICA<br>치료: 급성기 치료로 tPA, Intra-arterial thrombectomy를 하고 2차 예방을 위해 anticoagulant를 쓸 수 있다." },
    { q: "Gerstmann syndrome 증상들을 쓰시오.", a: "Agraphia or dysgraphia<br>Acalculia or dyscalculia<br>Finger agnosia<br>Left Right disorientation" },
    { q: "54세 남자환자가 dizziness를 주소로 증상 발생 후 3시간만에 응급실로 내원하였다. 환자는 HTN으로 진단받아 med. 복용하고 있었으며 20갑년의 흡연력이 있었다.<br>신경학적 진찰 상 ipsipulsion과 nystagmus가 있었으며, Rt. side V1-3 region에 감각 저하 및 동측 Honer syndrome 확인되었다. <br>환자는 말할 때 쉰목소리가 나온다고 했으며, 응급실 내원 후 약을 먹기 위해 물을 마실 때 심하게 사래에 걸렸다. <br>또한 가만히 앉아있어도 오른쪽으로 기우는 증상이 발생했으며, Rt. side severe dysmetria 관찰되었다. 또한 점점 왼쪽 상하지 온도, 통증 감각이 저하되는 것 같다고 했다. <br>현재 환자의 신경학적 진찰을 토대로 가장 가능성 있는 진단명을 쓰고, 어떤 혈관에 문제가 생겼을 지 쓰시오.", a: "진단명: Rt. Lateral medullary syndrome<br>혈관: Rt. PICA(posterior inferior cerebellar artery)" },
    { q: "73세 남자가 2시간 전에 발생한 dizziness를 주소로 본원 응급실 내원하였다. 과거력으로는 HTN, 20갑년의 흡연력 있었으며, 이전에 Acute infarction in Lt. subcortex로 진단받아 본원 신경과 입원치료 받은 적 있었다. <br>환자분 신경학적 진찰을 했을 때 아래와 같은 안구 움직임이 관찰되었다. 해당 안구 움직임을 나타낼 수 있는 질환명을 쓰고 병터를 아래 그림에서 고르시오.<br><img src='3.png' style='max-width:600px;'><br><img src='4.png' style='max-width:600px;'>", a: "질환명: Lt. internuclear opthalmoplegia<br>병터: 병터 4" },
    { q: "34세 여자가 Lt. visual disturbance를 주소로 응급실에 내원하였다. 위 증상은 약 1달 전부터 서서히 시작되었다. <br>시력이상과 함께 이전처럼 색깔 구분도 잘 되지 않는다고 하며 왼쪽 눈을 눌렀을 때 pain을 호소하였다. <br>안구통증이나 시야증상은 뜨거운 물에 목욕을 했을 때 더 심해진다고 했다.<br>약 1년 전에는 오른쪽 속 끝에 저런 느낌이 약 1주일 정도 지속되었다가 호전되었다고 했으며, 고개를 아래로 숙였을 때 등을 타고 아래로 뻗치는 찌릿한 느낌이 동반되었다고 한다. <br>현재도 해당 증상은 조금 남아 있다고 했다. 그 외 신경학적 진찰 상 특이 소견은 관찰되지 않았다.<br>응급실 내원 후 촬영한 MRI 상 아래와 같은 소견이 확인되었다. 다음 물음에 답하시오.<br><img src='6.png' style='max-width:600px;'><br>가장 의심되는 질환명과 이와 감별해야 하는 질환을 2개 이상 쓰시오.", a: "의심되는 질환명: MS<br>감별해야 하는 질환: NMO, ADEM" },
    { q: "56세 여자환자가 갑자기 발생한 어지럼증을 주소로 내원하였다. 증상은 자세에 따라 변화가 없었고, 수 시간 동안 지속되었다. 동반된 증상으로 오심, 구토가 있었다. <br>살면서 이런 어지러움은 처음이라고 하였다. 4일 전에 감기 기운이 있어서 근처 내과에서 약을 타 먹었던 적이 있었다고 했다. <br>신경학적 진찰 시, right로 수평성분 nystagmus가 all position에서 관찰되었으며, Alexander’s law를 만족하였다. 그 밖에 청력저하 등 ear symptom은 없었다. <br>이 환자에서 가장 의심되는 진단명 한 개를 쓰고 감별해야 하는 질환 두 가지를 쓰시오. 또 해당 진단명일 때 꼭 시행해봐야 하는 neurology를 쓰시오.", a: "진단명: Lt. vestibular neuritis<br>감별질환: BPPV, Meniere disease<br>Neurology: HINTS(head impulse test, gaze evoked nystagmus, test for skew deviation)" },
    { q: "응급실에 36세 남자가 양측 하지 위약감을 내원하였다. 특이 과거력 진단받은 적은 없으나, 4일 전에 혼자 야식으로 치킨을 먹은 후 배탈이 난 적이 있었다고 했다. <br>배탈 난 후 양쪽 다리가 무거운듯한 느낌이 있었으나 특별히 거동 문제는 없었다고 했다. 현재는 하지 위약감 증상이 점점 악화되어 응급실로 내원하였다.<br>응급실 내원 당시 신경학적 진찰 상 facial palsy 있었으며 bilateral lower extremity grade 4로 측정되었다. 환자분 현재 양측 다리에 paresthesia도 동반되고 있다고 했다.<br>DTR 시행했을 때 양측 knee jerk에서 DTR 보이지 않았다. 다음 물음에 답하시오.<br>1. 상기 환자 신경학적 진찰 상 가장 의심되는 질환명을 쓰고, 해당 진단명의 진단기준을 아는 대로 쓰시오.<br>2. 위 질환명을 의심했을 때 시행해야 하는 검사와 특징적인 검사 소견을 쓰시오.", a: "질환명: Guillain-Barre syndrome<br>진단기준: 사진 참조<br><img src='5.png' style='max-width:600px;'><br>시행검사: NCS, CSF<br>검사 소견: NCS: demyelination 소견, CSF: albuminocytologic dissociation" },
    { q: "57세 여자가 headache를 주소로 신경과 외래에 내원하였다. 환자가 호소하는 두통은 일주일 중 거의 5일 동안 발생하였으며, 심할 때는 하루 종일 아프기도 한다고 했다. <br>심할 때 약을 먹으면 조금 호전되기도 하지만 다시 악화된다고 했다.<br>주로 왼쪽 fronto-temporal area에 통증이 있었으며 심장박동 주기처럼 박동성의 욱씬거리는 통증이 있었다. 통증 위치는 여기 저기 돌아다니기도 한다. <br>가장 심할 때 통증강도는 VAS 7-8점 정도이다. 통증이 너무 심할 때는 아무 일도 할 수 없을 정도여서 누워만 있을 정도라고 했다. <br>특히나 큰 소리가 나거나 밝은 빛을 보면 더 심해져서 문을 다 닫고 커튼도 쳐놓고 가만히 누워 있어야 한다고 했다. <br>두통 시작 전에 눈앞에 어른거리는 증상이나 번쩍거림은 없었다고 한다. 다음 물음에 답하시오.<br>위 환자의 진단명을 쓰시고, 치료법을 아는 대로 쓰시오.", a: "진단명: 편두통<br>치료법: triptan과 에르고트로 치료하고, propranolol과 같은 베타차단제를 예방치료에 이용할 수 있습니다." },
    { q: "Sensory aphasia를 보이는 환자에서 시행할 수 있는 language function test는?", a: "Fluency, comprehension, repetition" },
    { q: "문제가 생겼을 때 Sensory aphasia가 발생하는 영역과 cerebral artery를 쓰시오.", a: "Wernicke's area, inferior branch of lt. MCA" },
    { q: "편두통 환자에게 할 수 있는 급성 및 예방 치료를 각각 1개 이상 쓰시오.", a: "급성기: triptan, ergotamine <br>예방: 베타차단제(propranolol)" },
    { q: "사진상의 환자에서 보이는 N/ex를 2가지 쓰시오.<br><img src='7.png' style='max-width:600px;'>", a: "종양 등에 의한 뒤쪽 척수 압박시 N/Ex <br>진동감각 소실(tuning fork), 관절 위치감각 소실(proprioception), Romberg test 양성, 감각성 실조(sensory ataxia), stamping gait, 미세촉각 저하(2-point discrimination 장애), 통증·온도감각은 보존(anterolateral system 정상)" },
    { q: "??세 남자 전날 밤까지 증상 없었고, 8:00에 화장실 갈 때 증상 없었고, 8:30에 아침을 먹다가 오른팔에 힘이 없어서 9:00경 응급실에 내원하였다. <br>EKG 상 A-fib이 있었다. 약물 복용력과 질환력은 없다. <br>이 환자에게 시행할 수 있는 검사 혹은 치료를 1가지만 쓰시오.", a: "IV-tPA" },
    { q: "TOAST를 5가지 쓰시오", a: "Large artery atherosclerosis, Cardioembolism, Small vessel occlusion, Stroke of Other determined Etiology, Stroke of undetermined etiology" },
    { q: "Right VN 환자에게 보일 수 있는 N/ex를 3가지 쓰시오.", a: "HIT(+), GEN(-), skew deviation(-)" },
    { q: "의식이 없는 환자에게 할 수 있는 N/ex를 5가지 쓰고, 간단히 설명하시오.", a: "light reflex : CN 2->3 이 관여하는 반사로, 동공에 빛을 쏘이면 양안의 동공수축이 발생해야 정상입니다. <br>gag reflex : CN 9, 10이 관여하는 반사로, 설압자로 혀 뒤쪽을 누르면 발생해야 정상입니다. <br>head impulse test : VOR, 전정기능을 평가하는 검사로 환자의 머리를 한쪽으로 빠르게 돌렸을 때 눈이 머리방향을 따라가지 않고 앞을 볼 수 있어야 정상입니다. 이상이 있는 경우 catch-up saccade가 나타납니다. <br>oculocephalic reflex(doll’s eye reflex) : 환자의 머리를 옆으로 돌렸을 때 눈이 머리를 따라 움직이지 않고 정면을 향해 있을 수 있어야 정상입니다. <br>병적 반사 : babinski sign, hoffmann sign 등" },
    { q: "중증근무력증을 진단할 수 있는 검사를 2가지 이상 쓰시오.", a: "RNS test, Tensilon test, Single-fiber EMG, Serology(Ab test)" },
    { q: "Myelopathy와 radiculopathy의 차이 및 구분할 수 있는 방법을 자유롭게 기술하시오.", a: "<img src='8.png' style='max-width:600px;'>" },
    { q: "", a: "" },
    { q: "", a: "" },
    { q: "", a: "" },
    { q: "", a: "" },
    { q: "", a: "" },
    { q: "", a: "" },
    { q: "", a: "" },
    { q: "", a: "" },
    { q: "", a: "" },
    { q: "", a: "" },
    { q: "", a: "" },
    { q: "", a: "" }
  ];

  const KEY = {
    WRONG: 'quiz_wrong_v1',
    MODE: 'quiz_mode_v1',
    NORMAL_ORDER: 'quiz_normal_order_v1',
    NORMAL_IDX: 'quiz_normal_idx_v1',
    REVIEW_ORDER: 'quiz_review_order_v1',
    REVIEW_IDX: 'quiz_review_idx_v1'
  };

  let wrongList = JSON.parse(localStorage.getItem(KEY.WRONG) || '[]');
  let mode = localStorage.getItem(KEY.MODE) || 'normal';
  let orderNormal = JSON.parse(localStorage.getItem(KEY.NORMAL_ORDER) || 'null');
  let idxNormal = parseInt(localStorage.getItem(KEY.NORMAL_IDX) || '0', 10);
  let orderReview = JSON.parse(localStorage.getItem(KEY.REVIEW_ORDER) || 'null');
  let idxReview = parseInt(localStorage.getItem(KEY.REVIEW_IDX) || '0', 10);

  const elStatus = document.getElementById('status');
  const elQuestion = document.getElementById('question');
  const elAnswer = document.getElementById('answer');
  const elBtnShow = document.getElementById('btnShowAnswer');
  const elBtnWrong = document.getElementById('btnMarkWrong');
  const elBtnNext = document.getElementById('btnNext');
  const elBtnPrev = document.getElementById('btnPrev');
  const elBtnToggle = document.getElementById('btnToggleMode');
  const elBtnReset = document.getElementById('btnReset');
  const elProgressInfo = document.getElementById('progressInfo');
  const elProgressInner = document.getElementById('progressInner');
  const elBtnRestartReview = document.getElementById('btnRestartReview');
  const elBtnRemoveWrong = document.getElementById('btnRemoveWrong');

  function shuffledArray(n){
    const arr = Array.from({length:n}, (_,i)=>i);
    for(let i=arr.length-1;i>0;i--){
      const j=Math.floor(Math.random()*(i+1));
      [arr[i],arr[j]]=[arr[j],arr[i]];
    }
    return arr;
  }

  function saveAll(){
    localStorage.setItem(KEY.WRONG, JSON.stringify(wrongList));
    localStorage.setItem(KEY.MODE, mode);
    if(orderNormal) localStorage.setItem(KEY.NORMAL_ORDER, JSON.stringify(orderNormal));
    localStorage.setItem(KEY.NORMAL_IDX, idxNormal);
    if(orderReview) localStorage.setItem(KEY.REVIEW_ORDER, JSON.stringify(orderReview));
    localStorage.setItem(KEY.REVIEW_IDX, idxReview);
  }

  function clearAll(){
    localStorage.removeItem(KEY.WRONG);
    localStorage.removeItem(KEY.MODE);
    localStorage.removeItem(KEY.NORMAL_ORDER);
    localStorage.removeItem(KEY.NORMAL_IDX);
    localStorage.removeItem(KEY.REVIEW_ORDER);
    localStorage.removeItem(KEY.REVIEW_IDX);
    wrongList = [];
    mode = 'normal';
    orderNormal=null; orderReview=null;
    idxNormal=0; idxReview=0;
  }

  function ensureOrders(){
    if(!orderNormal || !Array.isArray(orderNormal) || orderNormal.length !== questions.length){
      orderNormal = shuffledArray(questions.length);
      idxNormal = Math.min(Math.max(0, idxNormal), Math.max(0, orderNormal.length-1));
    }
    if(!orderReview || !Array.isArray(orderReview) || orderReview.length !== wrongList.length){
      orderReview = shuffledArray(wrongList.length);
      idxReview = Math.min(Math.max(0, idxReview), Math.max(0, orderReview.length-1));
    } else {
      idxReview = Math.min(Math.max(0, idxReview), Math.max(0, orderReview.length-1));
    }
  }

  function currentListAndIndex(){
    if(mode==='normal'){
      return {listType:'normal', order:orderNormal, idx:idxNormal, total:orderNormal.length};
    } else {
      return {listType:'review', order:orderReview, idx:idxReview, total:orderReview.length};
    }
  }

  function getCurrentQuestion(){
    const info = currentListAndIndex();
    if(info.total===0) return null;
    if(info.listType==='normal'){
      return questions[info.order[info.idx]];
    } else {
      return wrongList[info.order[info.idx]];
    }
  }

  function updateProgressBar(idx,total,percent){
    elProgressInfo.innerText=`진행: ${idx}/${total}  (${percent}%)`;
    elProgressInner.style.width=total===0?'0%':`${percent}%`;
  }

  function updateToggleText(){
    elBtnToggle.textContent = mode==='normal'?`복습 모드 (${wrongList.length})`:'일반 모드로';
  }

  function render(){
    ensureOrders();
    saveAll();
    const info=currentListAndIndex();

    // 버튼 표시
    if(mode==='review' && info.total>0){
      elBtnRestartReview.style.display='inline-block';
      elBtnRemoveWrong.style.display='inline-block';
    } else {
      elBtnRestartReview.style.display='none';
      elBtnRemoveWrong.style.display='none';
    }

    if(info.total===0){
      elStatus.innerText = mode==='normal'?'문제가 비어있습니다. questions 배열을 채워주세요.':'복습할 문제가 없습니다.';
      elQuestion.innerText = mode==='normal'?'문제가 없습니다.':'복습할 문제가 없습니다.';
      elAnswer.style.display='none';
      updateProgressBar(0,info.total,0);
      updateToggleText();
      return;
    }

    // 완료 상태 반영 (추가: 복습 모드도 진행률 끝까지)
    if(info.idx >= info.total){
      elQuestion.innerText='모든 문제가 완료되었습니다.';
      elAnswer.style.display='none';
      updateProgressBar(info.total, info.total, 100);
      updateToggleText();
      return;
    }

    const cur = getCurrentQuestion();
    if(!cur){
      elQuestion.innerText='문제가 없습니다.';
      elAnswer.style.display='none';
      updateProgressBar(info.idx,info.total,Math.round((info.idx/Math.max(1,info.total))*100));
      updateToggleText();
      return;
    }

    elQuestion.innerHTML = cur.q;
    elAnswer.innerHTML = cur.a;
    elAnswer.style.display='none';

    const currentNumber=info.idx+1;
    const remaining=Math.max(0,info.total-info.idx-1);
    elStatus.innerText=`모드: ${mode==='normal'?'일반':'복습'}  •  ${currentNumber} / ${info.total}  (남음: ${remaining})`;
    updateProgressBar(info.idx, info.total, Math.round((info.idx/Math.max(1,info.total))*100));
    updateToggleText();
  }

  function showAnswer(){
    const cur = getCurrentQuestion();
    if(!cur) return;
    elAnswer.style.display='block';
  }

  function markWrong(){
    const info=currentListAndIndex();
    if(info.total===0 || info.idx>=info.total) return;
    const cur=getCurrentQuestion();
    if(!cur) return;
    if(!wrongList.some(it=>it.q===cur.q && it.a===cur.a)){
      wrongList.push({q:cur.q,a:cur.a});
      orderReview=shuffledArray(wrongList.length);
      idxReview=Math.min(idxReview, orderReview.length-1);
      saveAll();
      updateToggleText();
    }
  }

  function removeWrong(){
    const cur=getCurrentQuestion();
    if(!cur) return;
    if(removeFromWrongListByQA(cur.q,cur.a)){
      // 현재 문제 제거 후 idxReview가 총 문제 수를 초과하면 마지막으로
      if(idxReview >= wrongList.length) idxReview = Math.max(0, wrongList.length-1);
      saveAll();
      render();
    }
  }

  function nextQuestion(){
    const info=currentListAndIndex();
    if(info.total===0){ render(); return; }
    if(info.listType==='normal'){
      idxNormal++;
      if(idxNormal>info.total) idxNormal=info.total;
    } else {
      idxReview++;
      if(idxReview>info.total) idxReview=info.total;
    }
    saveAll();
    render();
  }

  function prevQuestion(){
    const info=currentListAndIndex();
    if(info.total===0){ render(); return; }
    if(info.listType==='normal'){
      if(idxNormal<=0) return;
      idxNormal = Math.max(0, idxNormal-1);
      const prev = questions[orderNormal[idxNormal]];
      if(prev) removeFromWrongListByQA(prev.q,prev.a);
    } else {
      if(idxReview<=0) return;
      idxReview=Math.max(0, idxReview-1);
    }
    saveAll();
    render();
  }

  function removeFromWrongListByQA(q,a){
    const i = wrongList.findIndex(it=>it.q===q && it.a===a);
    if(i!==-1){
      wrongList.splice(i,1);
      orderReview=shuffledArray(wrongList.length);
      idxReview=Math.min(idxReview, Math.max(0, orderReview.length-1));
      if(mode==='review' && wrongList.length===0){
        mode='normal';
        localStorage.setItem(KEY.MODE, mode);
      }
      saveAll();
      updateToggleText();
      return true;
    }
    return false;
  }

  function restartReview(){
    idxReview=0;
    saveAll();
    render();
  }

  function toggleMode(){
    mode = (mode==='normal')?'review':'normal';
    localStorage.setItem(KEY.MODE, mode);
    if(mode==='review' && wrongList.length===0){
      alert('복습할 오답이 없습니다.');
      mode='normal';
      localStorage.setItem(KEY.MODE, mode);
      return;
    }
    ensureOrders();
    render();
  }

  function resetProgress(){
    if(!confirm('진행 상황(섞인 순서 및 인덱스)과 오답 목록을 초기화할까요?')) return;
    clearAll();
    ensureOrders();
    saveAll();
    render();
  }

  elBtnShow.addEventListener('click', showAnswer);
  elBtnWrong.addEventListener('click', markWrong);
  elBtnNext.addEventListener('click', nextQuestion);
  elBtnPrev.addEventListener('click', prevQuestion);
  elBtnToggle.addEventListener('click', toggleMode);
  elBtnReset.addEventListener('click', resetProgress);
  elBtnRestartReview.addEventListener('click', restartReview);
  elBtnRemoveWrong.addEventListener('click', removeWrong);

  if('serviceWorker' in navigator){
    window.addEventListener('load',()=>{navigator.serviceWorker.register('sw.js?v=5').catch(e=>{console.warn('ServiceWorker 등록 실패:',e);});});
  }

  ensureOrders();
  render();
</script>
</body>
</html>
