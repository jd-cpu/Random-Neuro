<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>신경과 랜덤 Post-test 퀴즈</title>
  <link rel="manifest" href="manifest.json">
  <meta name="theme-color" content="#4CAF50">
  <style>
    body { font-family: Arial, sans-serif; max-width:800px; margin:20px auto; padding:16px; text-align:center; }
    header { display:flex; justify-content:space-between; align-items:center; gap:12px; }
    h1 { margin:0; font-size:1.25rem; }
    #status { color:#666; font-size:0.95rem; margin-top:8px; text-align:left; }
    .question { margin:20px 0; font-size:1.15rem; white-space:pre-line; text-align:left; }
    .answer { margin-top:10px; font-weight:600; color:#0a6; white-space:pre-line; display:none; text-align:left; }
    .controls { margin-top:18px; }
    button { padding:10px 14px; margin:6px; font-size:1rem; }
    .progress-wrap { margin-top:14px; text-align:left; }
    .progress-info { font-size:0.92rem; color:#444; margin-bottom:6px; }
    .progress-bar { width:100%; height:12px; background:#eee; border-radius:8px; overflow:hidden; }
    .progress-inner { height:100%; width:0%; background:#4caf50; transition: width 0.25s ease; }
    small.note { display:block; color:#888; margin-top:8px; text-align:left; }
  </style>
</head>
<body>
  <header>
    <h1>신경과 랜덤 Post-test 퀴즈</h1>
    <div>
      <button id="btnToggleMode">복습 모드로</button>
      <button id="btnReset">초기화</button>
    </div>
  </header>

  <div id="status" aria-live="polite">로딩 중...</div>

  <div class="question" id="question">문제가 여기에 표시됩니다.</div>
  <div class="answer" id="answer"></div>

  <div class="controls" id="controls">
    <button id="btnShowAnswer">정답 보기</button>
    <button id="btnMarkWrong">오답 저장</button>
    <button id="btnPrev">이전 문제</button>
    <button id="btnNext">다음 문제</button>
  </div>

  <div class="progress-wrap">
    <div class="progress-info" id="progressInfo">진행: 0 / 0 (남음: 0)</div>
    <div class="progress-bar"><div id="progressInner" class="progress-inner"></div></div>
    <small class="note">※ 정답 보기 버튼은 정답만 보여줍니다. 다음 문제로 이동하려면 '다음 문제' 버튼을 누르세요.</small>
  </div>

  <script>
  const questions = [
    { q: "62세 오른손잡이 남자 환자가 ...", a: "1. Broca’s aphasia<br><img src='1.png' style='max-width:200px;'><br>2. Grade 3<br><img src='2.png' style='max-width:200px;'><br>3. ..." },
    { q: "Piaget의 인지 발달 4단계 ...", a: "감각운동기(출생-2세)<br>전조작기(2-7세)<br>구체적 조작기(7-12세)<br>형식적 조작기(12세-)" }
  ];

  const KEY = {
    WRONG: 'quiz_wrong_v1',
    MODE: 'quiz_mode_v1',
    NORMAL_ORDER: 'quiz_normal_order_v1',
    NORMAL_IDX: 'quiz_normal_idx_v1',
    REVIEW_ORDER: 'quiz_review_order_v1',
    REVIEW_IDX: 'quiz_review_idx_v1'
  };

  let wrongList = JSON.parse(localStorage.getItem(KEY.WRONG) || '[]');
  let mode = localStorage.getItem(KEY.MODE) || 'normal';

  let orderNormal = JSON.parse(localStorage.getItem(KEY.NORMAL_ORDER) || 'null');
  let idxNormal = parseInt(localStorage.getItem(KEY.NORMAL_IDX) || '0', 10);
  let orderReview = JSON.parse(localStorage.getItem(KEY.REVIEW_ORDER) || 'null');
  let idxReview = parseInt(localStorage.getItem(KEY.REVIEW_IDX) || '0', 10);

  const elStatus = document.getElementById('status');
  const elQuestion = document.getElementById('question');
  const elAnswer = document.getElementById('answer');
  const elBtnShow = document.getElementById('btnShowAnswer');
  const elBtnWrong = document.getElementById('btnMarkWrong');
  const elBtnNext = document.getElementById('btnNext');
  const elBtnPrev = document.getElementById('btnPrev');
  const elBtnToggle = document.getElementById('btnToggleMode');
  const elBtnReset = document.getElementById('btnReset');
  const elProgressInfo = document.getElementById('progressInfo');
  const elProgressInner = document.getElementById('progressInner');

  function shuffledArray(n) {
    const arr = Array.from({length:n}, (_,i)=>i);
    for (let i = arr.length -1; i>0; i--) {
      const j = Math.floor(Math.random() * (i+1));
      [arr[i], arr[j]] = [arr[j], arr[i]];
    }
    return arr;
  }

  function saveAll() {
    localStorage.setItem(KEY.WRONG, JSON.stringify(wrongList));
    localStorage.setItem(KEY.MODE, mode);
    if (orderNormal) localStorage.setItem(KEY.NORMAL_ORDER, JSON.stringify(orderNormal));
    localStorage.setItem(KEY.NORMAL_IDX, idxNormal);
    if (orderReview) localStorage.setItem(KEY.REVIEW_ORDER, JSON.stringify(orderReview));
    localStorage.setItem(KEY.REVIEW_IDX, idxReview);
  }

  function clearAll() {
    localStorage.removeItem(KEY.WRONG);
    localStorage.removeItem(KEY.MODE);
    localStorage.removeItem(KEY.NORMAL_ORDER);
    localStorage.removeItem(KEY.NORMAL_IDX);
    localStorage.removeItem(KEY.REVIEW_ORDER);
    localStorage.removeItem(KEY.REVIEW_IDX);
    wrongList = [];
    mode = 'normal';
    orderNormal = null; orderReview = null;
    idxNormal = 0; idxReview = 0;
  }

  function ensureOrders() {
    if (!orderNormal || orderNormal.length !== questions.length) {
      orderNormal = shuffledArray(questions.length);
      idxNormal = Math.min(Math.max(0, idxNormal), Math.max(0, orderNormal.length - 1));
    }
    if (!orderReview || orderReview.length !== wrongList.length) {
      orderReview = shuffledArray(wrongList.length);
      idxReview = Math.min(Math.max(0, idxReview), Math.max(0, orderReview.length - 1));
    } else {
      idxReview = Math.min(Math.max(0, idxReview), Math.max(0, orderReview.length - 1));
    }
  }

  function currentListAndIndex() {
    if (mode === 'normal') {
      return { listType: 'normal', order: orderNormal, idx: idxNormal, total: orderNormal.length };
    } else {
      return { listType: 'review', order: orderReview, idx: idxReview, total: orderReview.length };
    }
  }

  function getCurrentQuestion() {
    const info = currentListAndIndex();
    if (info.total === 0) return null;
    if (info.listType === 'normal') {
      return questions[info.order[info.idx]];
    } else {
      return wrongList[info.order[info.idx]];
    }
  }

  function render() {
    ensureOrders();
    saveAll();
    const info = currentListAndIndex();

    if (info.total === 0) {
      elStatus.innerText = mode === 'normal' ? '문제가 비어있습니다.' : '복습할 문제가 없습니다.';
      elQuestion.innerHTML = mode === 'normal' ? '문제가 없습니다.' : '복습할 문제가 없습니다.';
      elAnswer.style.display = 'none';
      updateProgressBar(0, info.total, 0);
      updateToggleText();
      return;
    }

    if (info.idx >= info.total) {
      elQuestion.innerHTML = '모든 문제가 완료되었습니다.';
      elAnswer.style.display = 'none';
      updateProgressBar(info.total, info.total, 100);
      updateToggleText();
      return;
    }

    const cur = getCurrentQuestion();
    if (!cur) {
      elQuestion.innerHTML = '문제가 없습니다.';
      elAnswer.style.display = 'none';
      updateProgressBar(info.idx, info.total, Math.round((info.idx / Math.max(1, info.total)) * 100));
      updateToggleText();
      return;
    }

    elQuestion.innerHTML = cur.q;
    elAnswer.innerHTML = cur.a;
    elAnswer.style.display = 'none';

    const currentNumber = info.idx + 1;
    const remaining = Math.max(0, info.total - info.idx - 1);
    elStatus.innerText = `모드: ${mode === 'normal' ? '일반' : '복습'}  •  ${currentNumber} / ${info.total}  (남음: ${remaining})`;
    updateProgressBar(info.idx, info.total, Math.round((info.idx / Math.max(1, info.total)) * 100));
    updateToggleText();
  }

  function updateProgressBar(idx, total, percent) {
    elProgressInfo.innerText = `진행: ${idx}/${total}  (${percent}%)`;
    elProgressInner.style.width = total === 0 ? '0%' : `${percent}%`;
  }

  function updateToggleText() {
    elBtnToggle.textContent = mode === 'normal' ? `복습 모드 (${wrongList.length})` : '일반 모드로';
  }

  function removeFromWrongListByQA(q, a) {
    const i = wrongList.findIndex(it => it.q === q && it.a === a);
    if (i !== -1) {
      wrongList.splice(i, 1);
      orderReview = shuffledArray(wrongList.length);
      idxReview = Math.min(idxReview, Math.max(0, orderReview.length - 1));
      if (mode === 'review' && wrongList.length === 0) {
        mode = 'normal';
        localStorage.setItem(KEY.MODE, mode);
      }
      saveAll();
      updateToggleText();
      return true;
    }
    return false;
  }

  function showAnswer() {
    const cur = getCurrentQuestion();
    if (!cur) return;
    elAnswer.style.display = 'block';
  }

  function markWrong() {
    const info = currentListAndIndex();
    if (info.total === 0 || info.idx >= info.total) return;
    const cur = getCurrentQuestion();
    if (!cur) return;
    if (!wrongList.some(it => it.q === cur.q && it.a === cur.a)) {
      wrongList.push({ q: cur.q, a: cur.a });
      orderReview = shuffledArray(wrongList.length);
      idxReview = Math.min(idxReview, orderReview.length - 1);
      saveAll();
      updateToggleText();
    }
  }

  function nextQuestion() {
    const info = currentListAndIndex();
    if (info.total === 0) { render(); return; }
    if (info.listType === 'normal') {
      idxNormal++;
    } else {
      idxReview++;
    }
    saveAll();
    render();
  }

  function prevQuestion() {
    const info = currentListAndIndex();
    if (info.total === 0) { render(); return; }
    if (info.listType === 'normal') {
      if (idxNormal <= 0) return;
      idxNormal = Math.max(0, idxNormal - 1);
      const qIndex = orderNormal[idxNormal];
      const prev = questions[qIndex];
      if (prev) removeFromWrongListByQA(prev.q, prev.a);
    } else {
      if (idxReview <= 0) return;
      idxReview = Math.max(0, idxReview - 1);
    }
    saveAll();
    render();
  }

  function toggleMode() {
    mode = (mode === 'normal') ? 'review' : 'normal';
    localStorage.setItem(KEY.MODE, mode);
    if (mode === 'review' && wrongList.length === 0) {
      alert('복습할 오답이 없습니다.');
      mode = 'normal';
      localStorage.setItem(KEY.MODE, mode);
      return;
    }
    ensureOrders();
    render();
  }

  function resetProgress() {
    if (!confirm('진행 상황과 오답 목록을 초기화할까요?')) return;
    clearAll();
    ensureOrders();
    saveAll();
    render();
  }

  elBtnShow.addEventListener('click', showAnswer);
  elBtnWrong.addEventListener('click', markWrong);
  elBtnNext.addEventListener('click', nextQuestion);
  elBtnPrev.addEventListener('click', prevQuestion);
  elBtnToggle.addEventListener('click', toggleMode);
  elBtnReset.addEventListener('click', resetProgress);

  if ('serviceWorker' in navigator) {
    window.addEventListener('load', () => {
      navigator.serviceWorker.register('sw.js').catch(e => {
        console.warn('ServiceWorker 등록 실패:', e);
      });
    });
  }

  ensureOrders();
  render();
  </script>
</body>
</html>
